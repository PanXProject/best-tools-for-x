name: Update Tool Awards

on:
  schedule:
    # Daily at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      award_type:
        description: 'Type of award to update (daily/weekly/monthly/yearly)'
        required: true
        default: 'daily'
        type: choice
        options:
          - daily
          - weekly
          - monthly
          - yearly

jobs:
  update-awards:
    runs-on: ubuntu-latest
    environment: Supabase
    
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          npm install @supabase/supabase-js dayjs gray-matter
          
      - name: Create awards script
        run: |
          mkdir -p .github/scripts
          cat > .github/scripts/updateAwards.mjs << 'EOF'
          import { createClient } from '@supabase/supabase-js';
          import dayjs from 'dayjs';
          import utc from 'dayjs/plugin/utc.js';
          import timezone from 'dayjs/plugin/timezone.js';
          import isSameOrAfter from 'dayjs/plugin/isSameOrAfter.js';
          import isSameOrBefore from 'dayjs/plugin/isSameOrBefore.js';
          import { readFile, writeFile } from 'fs/promises';
          import { join } from 'path';
          import matter from 'gray-matter';

          dayjs.extend(utc);
          dayjs.extend(timezone);
          dayjs.extend(isSameOrAfter);
          dayjs.extend(isSameOrBefore);

          const TIMEZONE = 'UTC';
          const TOOLS_DIR = 'src/content/tools';
          const AR_TOOLS_DIR = 'src/content/tools/ar';

          const supabase = createClient(
            process.env.SUPABASE_URL,
            process.env.SUPABASE_ANON_KEY,
            {
              auth: {
                persistSession: false,
                autoRefreshToken: false
              }
            }
          );

          async function getToolUpvotes() {
            const { data: pages, error } = await supabase
              .from('pages')
              .select('id, total_upvotes, created_at');

            if (error) throw error;

            return pages.map(page => ({
              ...page,
              id: page.id.replace(/^tool?\//, '')
            }));
          }

          function getPeriodDates(periodType, now) {
            switch (periodType) {
              case 'daily': {
                const yesterday = now.subtract(1, 'day');
                return {
                  start: yesterday.startOf('day'),
                  end: yesterday.endOf('day'),
                  awardDate: yesterday.format('YYYY-MM-DD')
                };
              }
              case 'weekly': {
                const lastWeek = now.subtract(1, 'week');
                return {
                  start: lastWeek.startOf('week'),
                  end: lastWeek.endOf('week'),
                  awardDate: lastWeek.endOf('week').format('YYYY-MM-DD')
                };
              }
              case 'monthly': {
                const lastMonth = now.subtract(1, 'month');
                return {
                  start: lastMonth.startOf('month'),
                  end: lastMonth.endOf('month'),
                  awardDate: lastMonth.endOf('month').format('YYYY-MM-DD')
                };
              }
              case 'yearly': {
                const lastYear = now.subtract(1, 'year');
                return {
                  start: lastYear.startOf('year'),
                  end: lastYear.endOf('year'),
                  awardDate: lastYear.endOf('year').format('YYYY-MM-DD')
                };
              }
            }
          }

          async function determineWinners(tools, periodType, now) {
            const { start, end, awardDate } = getPeriodDates(periodType, now);

            console.log(`Determining ${periodType} winners for period:`, {
              start: start.format(),
              end: end.format(),
              awardDate
            });

            console.log('Start date:', start.format('YYYY-MM-DD HH:mm:ss'));
            console.log('End date:', end.format('YYYY-MM-DD HH:mm:ss'));

            const eligibleTools = tools
              .filter(tool => {
                const toolDate = dayjs(tool.created_at).tz(TIMEZONE);
                return toolDate.isSameOrAfter(start) && toolDate.isSameOrBefore(end);
              })
              .sort((a, b) => b.total_upvotes - a.total_upvotes);

            console.log('Eligible tools:', eligibleTools.map(t => ({
              id: t.id,
              created_at: dayjs(t.created_at).tz(TIMEZONE).format('YYYY-MM-DD HH:mm:ss'),
              upvotes: t.total_upvotes
            })));

            const winners = [];
            let currentRank = 1;
            let previousUpvotes = -1;

            for (const tool of eligibleTools) {
              if (tool.total_upvotes === 0) continue;

              if (tool.total_upvotes !== previousUpvotes) {
                currentRank = winners.length + 1;
              }

              if (currentRank <= 3) {
                winners.push({
                  slug: tool.id,
                  total_upvotes: tool.total_upvotes,
                  rank: currentRank,
                  awardDate
                });
              }

              previousUpvotes = tool.total_upvotes;
            }

            return winners;
          }
          
          async function updateToolMdx(toolPath, awardType, rank, awardDate) {
            try {
              console.log(`Attempting to update ${toolPath}`);
              
              // Check if file exists
              try {
                await readFile(toolPath, 'utf-8');
              } catch (error) {
                console.error(`File not found: ${toolPath}`);
                return;
              }
          
              const content = await readFile(toolPath, 'utf-8');
              console.log(`Successfully read file: ${toolPath}`);
              
              const { data, content: body } = matter(content);
              console.log('Current frontmatter:', data);
          
              // Awards accumulate over time, never get removed
              const existingAwards = Array.isArray(data.awards) ? data.awards : [];
              const newAward = `${awardType}-award-${rank}-${awardDate}`;
              
              console.log('Existing awards:', existingAwards);
              console.log('New award to add:', newAward);
              
              // Only add if this exact award doesn't already exist
              if (!existingAwards.includes(newAward)) {
                const updatedAwards = [...existingAwards, newAward];
                console.log('Updated awards array:', updatedAwards);
          
                const updatedData = {
                  ...data,
                  awards: updatedAwards
                };
          
                try {
                  const updatedContent = matter.stringify(body, updatedData);
                  await writeFile(toolPath, updatedContent);
                  console.log(`Successfully updated ${toolPath} with new award`);
                } catch (writeError) {
                  console.error(`Error writing to file ${toolPath}:`, writeError);
                }
              } else {
                console.log(`Award ${newAward} already exists in ${toolPath}`);
              }
            } catch (error) {
              console.error(`Error updating ${toolPath}:`, error);
            }
          }
          
          async function main() {
            try {
              const now = dayjs().tz(TIMEZONE);
              const tools = await getToolUpvotes();
              
              console.log('Retrieved tools:', tools.length);
              
              const awardType = process.env.AWARD_TYPE || 'daily';
              const isManualTrigger = process.env.GITHUB_EVENT_NAME === 'workflow_dispatch';
              
              console.log('Award type:', awardType);
              console.log('Is manual trigger:', isManualTrigger);
              
              // Skip time checks for manual runs
              if (isManualTrigger || 
                  awardType === 'daily' || 
                  (awardType === 'weekly' && now.day() === 0) ||
                  (awardType === 'monthly' && now.date() === 1) ||
                  (awardType === 'yearly' && now.month() === 0 && now.date() === 1)) {
                
                const winners = await determineWinners(tools, awardType, now);
                console.log('Winners determined:', winners);
                
                for (const winner of winners) {
                  const mainPath = join(TOOLS_DIR, `${winner.slug}.mdx`);
                  const arPath = join(AR_TOOLS_DIR, `${winner.slug}.mdx`);
                  
                  console.log('Processing winner:', {
                    slug: winner.slug,
                    rank: winner.rank,
                    mainPath,
                    arPath
                  });
          
                  await updateToolMdx(
                    mainPath,
                    awardType,
                    winner.rank,
                    winner.awardDate
                  );
                  await updateToolMdx(
                    arPath,
                    awardType,
                    winner.rank,
                    winner.awardDate
                  );
                }
                
                console.log(`${awardType} awards updated successfully`);
              } else {
                console.log(`Skipping ${awardType} awards update - not the right time`);
              }
            } catch (error) {
              console.error('Error in main execution:', error);
              process.exit(1);
            }
          }
          EOF
      - name: Debug Info
        run: |
          echo "Current working directory: $(pwd)"
          echo "Contents of src/content/tools:"
          ls -la src/content/tools || echo "Directory not found"
          echo "GITHUB_EVENT_NAME: $GITHUB_EVENT_NAME"
          echo "AWARD_TYPE: ${{ github.event.inputs.award_type || 'daily' }}"
          
      - name: Run awards script
        run: |
          export SUPABASE_URL="${SUPABASE_URL}"
          export SUPABASE_ANON_KEY="${SUPABASE_ANON_KEY}"
          export AWARD_TYPE="${{ github.event.inputs.award_type || 'daily' }}"
          # Run with Node.js in debug mode
          NODE_DEBUG=* node --trace-warnings .github/scripts/updateAwards.mjs 2>&1 | tee awards.log
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          
      - name: Show script output
        if: always()
        run: |
          echo "=== Script Output ==="
          cat awards.log || echo "No log file found"
          
      - name: Show git status
        if: always()
        run: |
          echo "=== Git Status ==="
          git status
          
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add src/content/tools/
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update ${{ github.event.inputs.award_type || 'daily' }} awards [skip ci]" && git push)

